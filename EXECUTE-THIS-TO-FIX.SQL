-- Script para criar a fun√ß√£o register_for_event_with_cyberpoints no banco de dados
-- Execute este script completo no SQL Editor do painel do Supabase

-- Primeiro, vamos verificar se a coluna updated_at existe na tabela event_registrations
-- Se n√£o existir, vamos adicion√°-la
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                 WHERE table_name='event_registrations' AND column_name='updated_at') THEN
    ALTER TABLE public.event_registrations ADD COLUMN updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
  END IF;
END $$;

-- Remover fun√ß√£o existente se houver
DROP FUNCTION IF EXISTS public.register_for_event_with_cyberpoints(BIGINT) CASCADE;

-- Criar fun√ß√£o para inscrever usu√°rio em evento com verifica√ß√£o de cyberpoints
CREATE OR REPLACE FUNCTION public.register_for_event_with_cyberpoints(p_event_id BIGINT)
RETURNS JSONB AS $$
DECLARE
  v_user_id UUID;
  v_event RECORD;
  v_user_points INTEGER;
  v_result JSONB;
BEGIN
  -- Obter ID do usu√°rio autenticado
  v_user_id := auth.uid();

  -- Verificar se usu√°rio est√° autenticado
  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'Usu√°rio n√£o autenticado';
  END IF;

  -- Buscar dados do evento
  SELECT
    e.id,
    e.title,
    e.inscription_price_cyberpoints,
    e.max_participants,
    e.current_participants,
    COALESCE(e.inscription_price_cyberpoints, 0) as effective_price
  INTO v_event
  FROM public.events e
  WHERE e.id = p_event_id;

  -- Verificar se evento existe
  IF NOT FOUND THEN
    RAISE EXCEPTION 'O evento com ID % n√£o foi encontrado. Por favor, verifique e tente novamente.', p_event_id;
  END IF;

  -- Verificar se evento ainda permite inscri√ß√µes
  IF v_event.max_participants IS NOT NULL AND v_event.current_participants >= v_event.max_participants THEN
    RAISE EXCEPTION 'O evento "%s" atingiu o limite m√°ximo de participantes (%s vagas). N√£o h√° mais vagas dispon√≠veis para inscri√ß√£o.', v_event.title, v_event.max_participants;
  END IF;

  -- Obter saldo atual de cyberpoints do usu√°rio
  SELECT cyber_points INTO v_user_points
  FROM public.profiles
  WHERE id = v_user_id;

  -- Verificar se usu√°rio tem saldo suficiente
  IF v_user_points < v_event.effective_price THEN
    RAISE EXCEPTION 'Voc√™ n√£o tem CyberPoints suficientes para se inscrever no evento "%s". Seu saldo atual √© de % CyberPoints, mas o custo da inscri√ß√£o √© de % CyberPoints. Adquira mais CyberPoints para concluir a inscri√ß√£o.',
                   v_event.title, v_user_points, v_event.effective_price;
  END IF;

  -- Verificar se o usu√°rio j√° est√° inscrito e confirmado antes de tentar inserir
  DECLARE
    current_status TEXT;
  BEGIN
    SELECT status INTO current_status
    FROM public.event_registrations
    WHERE event_id = p_event_id AND user_id = v_user_id;

    -- Se j√° estiver confirmado, impedir nova inscri√ß√£o
    IF FOUND AND current_status = 'confirmed' THEN
      RETURN jsonb_build_object(
        'success', false,
        'message', format('Voc√™ j√° est√° inscrito e confirmado no evento "%s". N√£o √© poss√≠vel realizar uma nova inscri√ß√£o.', v_event.title),
        'already_registered', true,
        'status', current_status
      );
    END IF;
  END;

  -- Iniciar transa√ß√£o para garantir consist√™ncia
  BEGIN
    -- Tenta inserir a inscri√ß√£o
    INSERT INTO public.event_registrations (event_id, user_id, user_nickname, user_email, user_whatsapp, status)
    SELECT
      p_event_id,
      v_user_id,
      p.nickname,
      p.email,
      p.whatsapp,
      'confirmed'
    FROM public.profiles p
    WHERE p.id = v_user_id
    ON CONFLICT (event_id, user_id)
    DO UPDATE SET status = 'confirmed';  -- Mant√©m o status como confirmado

    -- Descontar os pontos do usu√°rio (ser√° feito sempre, mas o sistema de pontos deve evitar descontos indevidos)
    v_result := add_cyber_points(
      v_user_id,
      -v_event.effective_price,  -- Valor negativo para descontar
      'spent',
      'event',
      format('Pagamento da inscri√ß√£o no evento: %s', v_event.title),
      p_event_id,
      'event',
      v_user_id
    );

    -- Retornar sucesso
    RETURN jsonb_build_object(
      'success', true,
      'message', format('üéâ Parab√©ns! Sua inscri√ß√£o no evento "%s" foi realizada com sucesso! Foram debitados %s CyberPoints do seu saldo.', v_event.title, v_event.effective_price),
      'event_id', p_event_id,
      'inscription_cost', v_event.effective_price,
      'points_deducted', v_event.effective_price,
      'remaining_points', (v_result->>'balance_after')::INTEGER
    );

  EXCEPTION
    WHEN unique_violation THEN
      -- Se j√° estiver inscrito, retornar mensagem adequada
      RETURN jsonb_build_object(
        'success', false,
        'message', format('Voc√™ j√° est√° inscrito no evento "%s". N√£o √© poss√≠vel realizar uma nova inscri√ß√£o.', v_event.title),
        'already_registered', true
      );
    WHEN OTHERS THEN
      -- Em caso de erro, retornar mensagem de erro
      RAISE EXCEPTION 'Ocorreu um erro inesperado ao processar sua inscri√ß√£o no evento "%s": %', v_event.title, SQLERRM;
  END;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Coment√°rio sobre a fun√ß√£o
COMMENT ON FUNCTION public.register_for_event_with_cyberpoints IS 'Fun√ß√£o para inscrever usu√°rio em evento com verifica√ß√£o e desconto de cyberpoints';

-- Criar pol√≠tica para permitir que usu√°rios chamem esta fun√ß√£o
GRANT EXECUTE ON FUNCTION public.register_for_event_with_cyberpoints(BIGINT) TO authenticated;

-- Verificar se a fun√ß√£o foi criada corretamente
SELECT routine_name, routine_type, data_type
FROM information_schema.routines 
WHERE routine_name = 'register_for_event_with_cyberpoints';